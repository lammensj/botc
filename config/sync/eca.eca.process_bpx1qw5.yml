uuid: 6c2ffbda-84c9-44cd-911e-da699a2f1d83
langcode: en
status: true
dependencies:
  module:
    - eca_base
    - eca_log
    - eca_tamper
    - http_client_manager
    - influxdb_bucket_eca
    - solcast_eca
id: process_bpx1qw5
modeller: bpmn_io
label: 'HEMS - Solcast to InfluxDB'
version: 1.0.0
weight: null
events:
  Event_0qv4993:
    plugin: 'eca_base:eca_custom'
    label: Event_0qv4993
    configuration:
      event_id: solcast
    successors:
      -
        id: Activity_176ao79
        condition: ''
  Event_10tfw76:
    plugin: 'eca_base:eca_custom'
    label: Event_10tfw76
    configuration:
      event_id: token_value
    successors:
      -
        id: Activity_0bluopo
        condition: ''
conditions:
  Flow_0oawq9e:
    plugin: eca_count
    configuration:
      negate: false
      case: false
      left: 'solcast_koren45:forecasts'
      right: '0'
      operator: greaterthan
      type: numeric
  Flow_19cmpo3:
    plugin: eca_token_exists
    configuration:
      negate: false
      token_name: 'solcast_koren45:forecasts'
  Flow_002fuva:
    plugin: eca_token_exists
    configuration:
      token_name: 'solcast_koren45:forecasts'
      negate: true
gateways:
  Gateway_1f9s9z5:
    type: 0
    successors:
      -
        id: Activity_11l58yr
        condition: Flow_0oawq9e
actions:
  Activity_176ao79:
    plugin: 'http_client_manager_preconfigured_request:koren45'
    label: 'Fetch data from API'
    configuration: {  }
    successors:
      -
        id: Activity_0qfzvov
        condition: ''
  Activity_0qfzvov:
    plugin: eca_privatetempstore_read
    label: 'Convert to token'
    configuration:
      collection: http_client_manager
      key: 'last result'
      token_name: solcast_koren45
    successors:
      -
        id: Activity_0b088b3
        condition: ''
  Activity_0b088b3:
    plugin: eca_keyvaluestore_write
    label: 'Store token'
    configuration:
      collection: influxdb_solcast
      key: result
      value: '"[solcast_koren45]"'
      use_yaml: false
      ifnotexists: false
    successors:
      -
        id: Gateway_1f9s9z5
        condition: ''
  Activity_11l58yr:
    plugin: eca_list_remove
    label: 'Pop item'
    configuration:
      value: ''
      token_name: forecast_item
      method: first
      index: ''
      list_token: 'solcast_koren45:forecasts'
    successors:
      -
        id: Activity_1j1lesx
        condition: ''
  Activity_1j0ibmn:
    plugin: eca_write_log_message
    label: 'Log invalid payload'
    configuration:
      channel: green_plug
      severity: '4'
      message: 'Forecasts not found in payload.'
    successors: {  }
  Activity_0bluopo:
    plugin: 'eca_tamper:json_decode'
    label: json_decode
    configuration:
      assoc: true
      eca_data: '[custom_event:payload]'
      eca_token_name: solcast_koren45
    successors:
      -
        id: Gateway_1f9s9z5
        condition: Flow_19cmpo3
      -
        id: Activity_1j0ibmn
        condition: Flow_002fuva
  Activity_1j1lesx:
    plugin: solcast_eca_set_interval_start
    label: 'Set period start'
    configuration:
      datetime: '[forecast_item:period_end]'
      datetime_format: 'Y-m-d\TH:i:s.u0p'
      period: '[forecast_item:period]'
      operation: sub
      eca_token_name: 'forecast_item:period_start'
    successors:
      -
        id: Activity_0w7j6rc
        condition: ''
      -
        id: Activity_1cm4rm1
        condition: ''
      -
        id: Activity_0uo2dsm
        condition: ''
  Activity_0qyyyf1:
    plugin: influxdb_create_point
    label: 'InfluxDB: create point'
    configuration:
      name: solcast
      tags: 'type: forecast'
      fields: |-
        pv_estimate: "[forecast_item:pv_estimate]"
        pv_estimate10: "[forecast_item:pv_estimate10]"
        pv_estimate90: "[forecast_item:pv_estimate90]"
      datetime: '[forecast_item:period_start]'
      datetime_format: 'Y-m-d\TH:i:s.u0p'
      precision: s
      eca_token_name: forecast_item_point
    successors:
      -
        id: Activity_1honbp3
        condition: ''
  Activity_1honbp3:
    plugin: influxdb_write_point
    label: 'InfluxDB: write point'
    configuration:
      eca_token_name: forecast_item_point
      bucket: green_plug
    successors:
      -
        id: Gateway_1f9s9z5
        condition: ''
  Activity_0w7j6rc:
    plugin: 'eca_tamper:number_format'
    label: 'Convert estm to float'
    configuration:
      decimals: '4'
      dec_point: .
      thousands_sep: ','
      eca_data: '[forecast_item:pv_estimate]'
      eca_token_name: '[forecast_item:pv_estimate]'
    successors:
      -
        id: Activity_19aczom
        condition: ''
  Activity_19aczom:
    plugin: 'eca_tamper:math'
    label: 'kW to W'
    configuration:
      operation: multiplication
      flip: false
      value: '1000'
      eca_data: '[forecast_item:pv_estimate]'
      eca_token_name: '[forecast_item:pv_estimate]'
    successors:
      -
        id: Activity_1v4zgu7
        condition: ''
  Activity_1v4zgu7:
    plugin: 'eca_tamper:cast_to_int'
    label: 'Convert to int'
    configuration:
      eca_data: '[forecast_item:pv_estimate]'
      eca_token_name: '[forecast_item:pv_estimate]'
    successors: {  }
  Activity_1cm4rm1:
    plugin: 'eca_tamper:number_format'
    label: 'Convert estm10 to float'
    configuration:
      decimals: '4'
      dec_point: .
      thousands_sep: ','
      eca_data: '[forecast_item:pv_estimate10]'
      eca_token_name: 'forecast_item:pv_estimate10'
    successors:
      -
        id: Activity_02m0ci0
        condition: ''
  Activity_02m0ci0:
    plugin: 'eca_tamper:math'
    label: 'kW to W'
    configuration:
      operation: multiplication
      flip: false
      value: '1000'
      eca_data: '[forecast_item:pv_estimate10]'
      eca_token_name: 'forecast_item:pv_estimate10'
    successors:
      -
        id: Activity_1kp5qbf
        condition: ''
  Activity_1kp5qbf:
    plugin: 'eca_tamper:cast_to_int'
    label: 'Convert to int'
    configuration:
      eca_data: '[forecast_item:pv_estimate10]'
      eca_token_name: 'forecast_item:pv_estimate10'
    successors: {  }
  Activity_0uo2dsm:
    plugin: 'eca_tamper:number_format'
    label: 'Convert estm90 to float'
    configuration:
      decimals: '4'
      dec_point: .
      thousands_sep: ','
      eca_data: '[forecast_item:pv_estimate90]'
      eca_token_name: 'forecast_item:pv_estimate90'
    successors:
      -
        id: Activity_160nolu
        condition: ''
  Activity_160nolu:
    plugin: 'eca_tamper:math'
    label: 'kW to W'
    configuration:
      operation: multiplication
      flip: false
      value: '1000'
      eca_data: '[forecast_item:pv_estimate90]'
      eca_token_name: 'forecast_item:pv_estimate90'
    successors:
      -
        id: Activity_0pmnmbw
        condition: ''
  Activity_0pmnmbw:
    plugin: 'eca_tamper:cast_to_int'
    label: 'Convert to int'
    configuration:
      eca_data: '[forecast_item:pv_estimate90]'
      eca_token_name: 'forecast_item:pv_estimate90'
    successors:
      -
        id: Activity_0qyyyf1
        condition: ''
